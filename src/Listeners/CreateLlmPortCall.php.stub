<?php

namespace App\Listeners\LlmPort;

use App\Models\LlmPortCall;
use Borah\LlmPort\Events\LlmChatResponseReceived;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Queue\InteractsWithQueue;

class CreateLlmPortCall implements ShouldQueue
{
    use InteractsWithQueue;

    /**
     * Create the event listener.
     */
    public function __construct()
    {
        //
    }

    /**
     * Handle the event.
     */
    public function handle(LlmChatResponseReceived $event): void
    {
        LlmPortCall::create([
            'driver' => $event->driver,
            'model_name' => $event->model->name,
            'messages' => $event->request->messages,
            'response' => $event->response->content,
            'temperature' => $event->request->temperature,
            'top_p' => $event->request->topP,
            'frequency_penalty' => $event->request->frequencyPenalty,
            'finish_reason' => $event->response->finishReason,
            'processing_time_in_ms' => $event->response->usage?->processingTimeInMs,
            'input_tokens' => $event->response->usage?->inputTokens,
            'output_tokens' => $event->response->usage?->outputTokens,
            'callable_id' => null,
            'callable_type' => null,
            'metadata' => $event->metadata,
        ]);
    }
}
